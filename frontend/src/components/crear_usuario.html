<!DOCTYPE html>
<html lang="es" class="h-full bg-gradient-to-br from-blue-50 via-sky-50 to-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crear Usuario</title>

  <!-- Tailwind CSS (CDN para rapidez; en prod mejor compilarlo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Heroicons (outline + solid via CDN) -->
  <script src="https://unpkg.com/heroicons@2.1.5"></script>
  <!-- Nota: también puedes usar SVG inline de Heroicons. Abajo uso SVGs embebidos. -->

  <!-- Font Awesome (opcional si quieres mantener tus íconos) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <style>
    .glass {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 45px rgba(2, 6, 23, 0.10);
    }
    .input-focus:focus {
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
      border-color: #3b82f6; /* blue-500 */
    }
  </style>
</head>
<body class="h-full">
  <div class="min-h-full flex items-center justify-center py-14 px-5">
    <div class="w-full max-w-2xl">
      <div class="glass rounded-3xl px-10 py-10">
        <!-- Header -->
        <div class="text-center mb-8">
          <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-2xl bg-blue-100 ring-8 ring-blue-50">
            <!-- Heroicon: User Plus (solid) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-blue-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0ZM12 14c-4.418 0-8 2.239-8 5v.75A.75.75 0 0 0 4.75 20h14.5a.75.75 0 0 0 .75-.75V19c0-2.761-3.582-5-8-5Z"/>
              <path d="M19 6.25a.75.75 0 0 1 .75.75v1.5h1.5a.75.75 0 0 1 0 1.5h-1.5v1.5a.75.75 0 0 1-1.5 0V10h-1.5a.75.75 0 0 1 0-1.5H18V7a.75.75 0 0 1 .75-.75Z"/>
            </svg>
          </div>
          <h1 class="mt-5 text-3xl sm:text-4xl font-extrabold tracking-tight text-gray-900">
            Crear usuario
          </h1>
          <p class="mt-2 text-base sm:text-lg text-gray-600">
            Completa los datos para agregar un nuevo miembro del equipo
          </p>
        </div>

        <!-- Feedback -->
        <div id="respuesta" class="hidden mb-5 rounded-xl border px-5 py-4 text-base"></div>

        <!-- Form -->
        <form class="grid grid-cols-1 gap-6" id="crearUsuarioForm">
          <div>
            <label for="username" class="block text-base font-semibold text-gray-800">Usuario o email</label>
            <div class="mt-2 relative">
              <input
                type="text"
                id="username"
                name="username"
                required
                placeholder="nombre@empresa.com"
                class="input-focus block w-full rounded-xl border border-gray-300 px-4 py-3.5 text-lg placeholder-gray-400 focus:outline-none focus:ring-0"
              />
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4 text-gray-400">
                <!-- Heroicon: Envelope (outline) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25H4.5A2.25 2.25 0 0 1 2.25 17.25V6.75M21.75 6.75A2.25 2.25 0 0 0 19.5 4.5H4.5A2.25 2.25 0 0 0 2.25 6.75m19.5 0-9.75 6.75L2.25 6.75"/>
                </svg>
              </div>
            </div>
          </div>

          <div>
            <label for="password" class="block text-base font-semibold text-gray-800">Contraseña</label>
            <div class="mt-2 relative">
              <input
                type="password"
                id="password"
                name="password"
                required
                placeholder="********"
                autocomplete="current-password"
                class="input-focus block w-full rounded-xl border border-gray-300 px-4 py-3.5 text-lg placeholder-gray-400 focus:outline-none focus:ring-0"
              />
              <button type="button" id="togglePwd" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600">
                <!-- Heroicon: Eye (outline) -->
                <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.644C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.577 3.01 9.964 7.178.07.207.07.437 0 .644C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.577-3.01-9.964-7.178Z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                </svg>
              </button>
            </div>
            <p class="mt-2 text-sm text-gray-500">Mínimo 8 caracteres. Ideal: mezcla de mayúsculas, números y símbolos.</p>
          </div>

          <div>
            <label for="role" class="block text-base font-semibold text-gray-800">Rol</label>
            <div class="mt-2 relative">
              <select
                id="role"
                name="role"
                class="input-focus block w-full rounded-xl border border-gray-300 bg-white px-4 py-3.5 text-lg focus:outline-none focus:ring-0"
              >
                <option value="operador">Operador</option>
                <option value="admin">Administrador</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-4 text-gray-400">
                <!-- Heroicon: Shield Check (outline) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M12 3.75l7.5 3v6a9 9 0 0 1-7.5 8.858A9 9 0 0 1 4.5 12.75v-6l7.5-3Z"/>
                </svg>
              </div>
            </div>
          </div>

          <button
            type="submit"
            id="submitBtn"
            class="inline-flex w-full items-center justify-center gap-3 rounded-2xl bg-blue-700 px-6 py-4 text-white text-lg font-semibold shadow-md hover:bg-blue-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 transition"
          >
            <!-- Heroicon: Check Circle (solid) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M2.25 12a9.75 9.75 0 1 1 19.5 0 9.75 9.75 0 0 1-19.5 0Zm14.03-2.78a.75.75 0 0 0-1.06-1.06L10.5 12.88l-1.72-1.72a.75.75 0 1 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.06 0l5.25-5.25Z" clip-rule="evenodd"/>
            </svg>
            <span>Crear usuario</span>
          </button>

          <a href="/dashboard"
             class="block text-center text-base font-medium text-blue-700 hover:text-blue-800 hover:underline transition">
            ← Volver al dashboard
          </a>
        </form>
      </div>

      <!-- Footer mini -->
      <p class="mt-8 text-center text-sm text-gray-400">
        © <span id="year"></span> Ranco. Todos los derechos reservados.
      </p>
    </div>
  </div>

  <script>
    // Año dinámico
    document.getElementById('year').textContent = new Date().getFullYear();

    // Toggle ver contraseña (cambia entre ojo abierto y cerrado)
    const toggle = document.getElementById('togglePwd');
    const pwd = document.getElementById('password');
    const eyeIcon = document.getElementById('eyeIcon');
    let eyeOpen = true;
    toggle.addEventListener('click', () => {
      eyeOpen = !eyeOpen;
      pwd.type = eyeOpen ? 'password' : 'text';
      // Cambia el icono entre ojo y ojo tachado
      eyeIcon.outerHTML = eyeOpen
        ? `<svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
             <path stroke-linecap="round" stroke-linejoin="round"
               d="M2.036 12.322a1.012 1.012 0 0 1 0-.644C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.577 3.01 9.964 7.178.07.207.07.437 0 .644C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.577-3.01-9.964-7.178Z"/>
             <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
           </svg>`
        : `<svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
             <path stroke-linecap="round" stroke-linejoin="round"
               d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 15.338 7.21 18 12 18c.97 0 1.905-.124 2.783-.356M6.228 6.228C7.928 5.445 9.892 5 12 5c4.79 0 8.774 2.662 10.066 6-0.38 1.027-0.987 1.966-1.777 2.77M3 3l18 18"/>
           </svg>`;
    });

    const respuesta = document.getElementById('respuesta');
    const submitBtn = document.getElementById('submitBtn');

    function showMessage(ok, msg) {
      respuesta.classList.remove('hidden');
      respuesta.classList.toggle('border-green-300', ok);
      respuesta.classList.toggle('text-green-800', ok);
      respuesta.classList.toggle('bg-green-50', ok);
      respuesta.classList.toggle('border-red-300', !ok);
      respuesta.classList.toggle('text-red-800', !ok);
      respuesta.classList.toggle('bg-red-50', !ok);
      respuesta.textContent = msg;
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitBtn.classList.toggle('opacity-70', loading);
      submitBtn.innerHTML = loading
        ? '<svg class="animate-spin h-6 w-6 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg><span class="ml-2">Creando…</span>'
        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
             <path fill-rule="evenodd" d="M2.25 12a9.75 9.75 0 1 1 19.5 0 9.75 9.75 0 0 1-19.5 0Zm14.03-2.78a.75.75 0 0 0-1.06-1.06L10.5 12.88l-1.72-1.72a.75.75 0 1 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.06 0l5.25-5.25Z" clip-rule="evenodd"/>
           </svg><span>Crear usuario</span>`;
    }

    document.getElementById('crearUsuarioForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;

      if (!username || !password) {
        showMessage(false, 'Completa usuario y contraseña.');
        return;
      }
      if (password.length < 8) {
        showMessage(false, 'La contraseña debe tener al menos 8 caracteres.');
        return;
      }

      setLoading(true);
      try {
        const res = await fetch('/api/create_user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // necesario para cookie de sesión
          body: JSON.stringify({ username, password, role })
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok && data.success) {
          showMessage(true, 'Usuario creado exitosamente.');
          e.target.reset();
        } else {
          const msg = data.error || data.message || 'Error al crear usuario';
          showMessage(false, msg);
        }
      } catch (err) {
        showMessage(false, 'No se pudo contactar al servidor.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>