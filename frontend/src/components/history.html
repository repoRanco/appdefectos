<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Historial - RancoQC T25</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f8fafc;          /* fondo general */
      --panel:#ffffff;        /* panel principal */
      --panel-2:#f1f5f9;      /* secciones y encabezados */
      --card:#ffffff;
      --muted:#64748b;        /* texto secundario */
      --text:#1e293b;         /* texto principal */
      --brand:#e11d48;        /* acento rosa/rojo suave */
      --brand-2:#f43f5e;
      --accent:#16a34a;       /* verde */
      --warn:#d97706;         /* ámbar */
      --border:#e2e8f0;       /* borde gris claro */
      --shadow:0 2px 8px rgba(0,0,0,.05);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", Roboto, sans-serif;
      min-height:100vh;
    }

    /* Header */
    .header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 24px;
      background:#fff;
      border-bottom:1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .header-left{display:flex;align-items:center;gap:12px}
    .logo{height:38px;width:auto}
    #module-title{font-size:20px;font-weight:600;color:var(--brand)}

    .header-right{display:flex;align-items:center;gap:16px}
    .db-status{
      display:flex;align-items:center;gap:8px;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--panel-2);
      font-size:13px;
      color:var(--muted);
    }
    .db-status.ok{background:#dcfce7; color:#166534; border-color:#bbf7d0;}
    .db-status.warn{background:#fef9c3;color:#78350f;border-color:#fde68a;}
    .db-status.err{background:#fee2e2;color:#991b1b;border-color:#fecaca;}

    .user-info{display:flex;align-items:center;gap:10px;color:var(--muted)}
    .current-time{font-variant-numeric:tabular-nums}

    /* Layout */
    .main-content{
      max-width:1200px;
      margin:24px auto;
      padding:0 20px 60px;
    }

    /* Buttons */
    button{font-family:inherit}
    .btn-icon{
      border:none; background:var(--panel-2);
      color:var(--text); width:38px; height:38px;
      border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      border:1px solid var(--border);
      transition:all .2s;
    }
    .btn-icon:hover{background:#e2e8f0;}

    .btn-primary,.btn-secondary{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 14px; border-radius:8px;
      border:1px solid transparent;
      font-weight:600; cursor:pointer; transition:all .2s;
      font-size:14px;
    }
    .btn-primary{
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      color:#fff;
    }
    .btn-primary:hover{filter:brightness(1.1)}
    .btn-secondary{
      background:var(--panel-2);
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{background:#e2e8f0;}

    /* Filters */
    .filters-section{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .form-group-inline{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
    .form-group{display:flex;flex-direction:column;gap:5px;min-width:220px}
    .form-group label{color:var(--muted);font-size:13px;font-weight:500}
    select{
      background:white;color:var(--text);
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px 12px;
      outline:none;
    }
    select:focus{border-color:#94a3b8;box-shadow:0 0 0 2px rgba(148,163,184,.2)}

    /* Stats */
    .stats-section{margin:18px 0}
    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
      gap:16px;
    }
    .stat-card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      padding:14px;
      display:flex;align-items:center;gap:12px;
      box-shadow:var(--shadow);
    }
    .stat-icon{
      width:42px;height:42px;
      border-radius:8px;
      display:flex;align-items:center;justify-content:center;
      background:#e2e8f0;color:#1e293b;
    }
    .stat-info h3{margin:0;font-size:22px;color:var(--text)}
    .stat-info p{margin:0;color:var(--muted);font-size:13px;}

    /* History table */
    .history-section{
      margin-top:20px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .history-header{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--panel-2);
      padding:12px 16px;
      border-bottom:1px solid var(--border);
    }
    .history-header h2{margin:0;display:flex;gap:8px;align-items:center;font-size:16px;color:var(--text)}
    .history-actions{display:flex;gap:6px;align-items:center;}

    .history-table-container{overflow:auto}
    .history-table{
      width:100%;
      border-collapse:collapse;
      min-width:900px;
    }
    th,td{padding:10px 14px; text-align:left; font-size:14px;}
    thead{background: var(--panel-2);}
    th{border-bottom:1px solid var(--border);color:var(--muted)}
    tbody tr:nth-child(odd){background:#f9fafb}
    tbody tr:hover{background:#e2e8f0}
    td{border-bottom:1px solid var(--border);color:var(--text)}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;
      border-radius:20px;
      font-size:12px;
      border:1px solid var(--border);
      background:#f1f5f9;
    }
    .badge.ok{background:#dcfce7; color:#166534;}
    .badge.warn{background:#fef9c3; color:#92400e;}
    .badge.err{background:#fee2e2; color:#991b1b;}

    /* Loading */
    .loading-container{display:flex;align-items:center;gap:10px;padding:16px;color:var(--muted)}
    .spinner{
      width:18px;height:18px;border:3px solid #e2e8f0;border-top-color:var(--brand);
      border-radius:50%;animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* No results */
    .no-results{text-align:center;padding:40px 20px;color:var(--muted);}
    .no-results i{font-size:26px;margin-bottom:6px;color:#94a3b8;}

    /* Modal */
    .modal{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.4);
      z-index:50;
    }
    .modal.open{display:flex;}
    .modal-content{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      width:min(800px,90vw);
      box-shadow:var(--shadow);
    }
    .modal-header,.modal-footer{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;
    }
    .modal-footer{border-bottom:none;border-top:1px solid var(--border);}
    .modal-body{padding:16px;}

    .close-btn{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;}
    .details-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .details-image img{width:100%;border-radius:8px;border:1px solid var(--border);}

    @media (max-width: 768px){
      .details-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="btn-icon" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
      <img src="../public/LogoColor.ddc5d2c8.png" alt="RancoQC" class="logo">
      <h1 id="module-title">Historial de Análisis</h1>
    </div>
    <div class="header-right">
      <div class="db-status" id="db-status">
        <i class="fas fa-database"></i>
        <span id="db-status-text">Verificando...</span>
      </div>
      <div class="user-info">
        <span id="user-name">Usuario</span>
        <span class="current-time" id="current-time">00:00</span>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Filtros -->
    <section class="filters-section">
      <div class="form-group-inline">
        <div class="form-group">
          <label for="filter-user">Usuario:</label>
          <select id="filter-user"><option value="">Todos los usuarios</option></select>
        </div>
        <div class="form-group">
          <label for="filter-type">Tipo de Análisis:</label>
          <select id="filter-type">
            <option value="">Todos los tipos</option>
            <option value="qc_recepcion">QC Recepción</option>
            <option value="packing_qc">Packing QC</option>
            <option value="contramuestra">Contramuestra</option>
          </select>
        </div>
        <div class="form-group">
          <label for="filter-limit">Mostrar:</label>
          <select id="filter-limit">
            <option value="20">Últimos 20</option>
            <option value="50" selected>Últimos 50</option>
            <option value="100">Últimos 100</option>
          </select>
        </div>
        <button class="btn-primary" onclick="loadHistory()"><i class="fas fa-search"></i>Buscar</button>
        <button class="btn-secondary" onclick="syncPendingData()" id="sync-btn"><i class="fas fa-sync-alt"></i>Sincronizar</button>
      </div>
    </section>

    <!-- Stats -->
    <section class="stats-section" id="stats-section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
          <div class="stat-info"><h3 id="total-records">0</h3><p>Registros Totales</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-database"></i></div>
          <div class="stat-info"><h3 id="synced-records">0</h3><p>Sincronizados</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-info"><h3 id="pending-records">0</h3><p>Pendientes</p></div>
        </div>
      </div>
    </section>

    <!-- Historial -->
    <section class="history-section">
      <div class="history-header">
        <h2><i class="fas fa-history"></i>Historial de Análisis</h2>
        <div class="history-actions">
          <button class="btn-secondary" onclick="exportHistoryToExcel()"><i class="fas fa-file-excel"></i> Exportar</button>
          <button class="btn-secondary" onclick="clearSyncedCache()"><i class="fas fa-trash"></i> Limpiar Caché</button>
        </div>
      </div>

      <div class="loading-container" id="history-loading" style="display:none;">
        <div class="spinner"></div><p>Cargando historial...</p>
      </div>

      <div class="history-table-container">
        <table class="history-table" id="history-table">
          <thead>
            <tr>
              <th>Fecha/Hora</th>
              <th>Usuario</th>
              <th>Tipo</th>
              <th>Lote</th>
              <th>Distribución</th>
              <th>Detecciones</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="history-tbody"></tbody>
        </table>
      </div>

      <div class="no-results" id="no-results" style="display:none;">
        <i class="fas fa-search"></i>
        <h3>No se encontraron registros</h3>
        <p>Prueba ajustando los filtros.</p>
      </div>
    </section>
  </main>

  <!-- Modal detalles -->
  <div id="details-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-info-circle"></i> Detalles del Análisis</h2>
        <button class="close-btn" onclick="closeDetailsModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="details-grid" id="details-content"></div>
        <div class="details-image" id="details-image-container" style="display:none;">
          <img id="details-image" alt="Imagen del análisis">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDetailsModal()">Cerrar</button>
        <button class="btn-primary" onclick="downloadAnalysisReport()"><i class="fas fa-download"></i> Descargar</button>
      </div>
    </div>
  </div>

  <script src="/js/history.js"></script>
</body>
</html>